#  SPDX-License-Identifier: BSD-3-Clause
#  Copyright (c) 2022-2024 NVIDIA CORPORATION & AFFILIATES.
#  All rights reserved.
#

job: spdk

registry_host: nbu-harbor.gtm.nvidia.com
registry_path: /swx-storage/spdk

credentials:
  - {credentialsId: 'svc-nbu-swx-repos', usernameVariable: 'REPO_USER', passwordVariable: 'REPO_PASS'}

failFast: false
kubernetes:
  cloud: il-ipp-blossom-prod
  namespace: nbu-swx-storage-devops
  runAsUser: "6213"
  runAsGroup: "11429"
  privileged: true

env:
  MOFED_VER: '${CI_ENV_MOFED_VER}' 
  REGISTRY_AUTH_FILE: '${CI_ENV_REGISTRY_AUTH_FILE}'
  GIT_SSH_COMMAND: '${CI_ENV_GIT_SSH_COMMAND}'

secret_volumes:
  - {secretName: 'mellanox-debs-keyring', mountPath: '/mnt/secret'}
  - {secretName: 'registry-auth-file', mountPath: '/mnt/secret_podman'}
  - {secretName: 'mellanox-github-rsa', mountPath: '/var/home/swx-jenkins/.ssh'}

runs_on_dockers:
  - {file: '.ci/Dockerfile.ubuntu20.04', name: 'ubuntu20_04', arch: 'aarch64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
  - {file: '.ci/Dockerfile.ubuntu22.04', name: 'ubuntu22_04', arch: 'aarch64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
#  - {file: '.ci/Dockerfile.centos7.9.2009', name: 'centos7_9', arch: 'aarch64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
  - {file: '.ci/Dockerfile.centos8', name: 'centos8_stream', arch: 'aarch64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
  - {file: '.ci/Dockerfile.openeuler.20.03', name: 'openeuler20_03', arch: 'aarch64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
  - {file: '.ci/Dockerfile.debian12', name: 'debian12', arch: 'aarch64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
  - {file: '.ci/Dockerfile.ubuntu20.04', name: 'ubuntu20_04', arch: 'x86_64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
  - {file: '.ci/Dockerfile.ubuntu22.04', name: 'ubuntu22_04', arch: 'x86_64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
  - {file: '.ci/Dockerfile.rockylinux9.2', name: 'rockylinux9_2', arch: 'aarch64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
#  - {file: '.ci/Dockerfile.centos7.9.2009', name: 'centos7_9', arch: 'x86_64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}
#  - {file: '.ci/Dockerfile.centos8', name: 'centos8_stream', arch: 'x86_64', build_args: '--build-arg MOFED_VER=$MOFED_VER', tag: '$MOFED_VER'}


steps:
  - name: Set correct rights
    run: |
      uid=$(id -u)
      gid=$(id -g)
      sudo chown -R $uid:$gid $WORKSPACE
      git config --global --add safe.directory "*"

  - name: Build distro package
    run: |
      if [[ -e /etc/redhat-release || -e /etc/openEuler-release ]]; then
        .ci/build_rpm.sh
      elif [ -e /etc/debian_version ]; then
        .ci/build_deb.sh
      else
        echo "[ERROR]: Unsupported OS!"
        exit 1
      fi

  - name: Upload distro package URM
    enable: true
    credentialsId: 'svc-nbu-swx-repos'
    resource: actions/nexus.py
    containerSelector:
      - "{name: 'ubuntu20_04', variant:1}"
      - "{name: 'ubuntu22_04', variant:1}"
      - "{name: 'centos7_9', variant:1}"
      - "{name: 'centos8_stream', variant:1}"
      - "{name: 'openeuler20_03', variant:1}"
      - "{name: 'debian12', variant:1}"
      - "{name: 'rockylinux9_2', variant:1}"
    run: |
      .ci/upload.sh urm

pipeline_stop:
  containerSelector:
      - "{name: 'ubuntu22_04'}"
  run: |
    if [[ ! -n "$ghprbPullId" && "$pipeline_status" == "SUCCESS" ]]; then
      .ci/git_tag.sh
    fi
